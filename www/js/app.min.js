angular.module("Spasey",["ionic","ngCordova"]).run(function(e){e.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&StatusBar.styleDefault()})}).config(function(e,o){e.state("map",{url:"/",templateUrl:"templates/map.html",controller:"MapCtrl"}),o.otherwise("/")}).factory("Markers",function(e){return{getMarkers:function(o){return e.get("http://localhost:8000/markers.php",{params:o}).then(function(e){var o=e;return o})},postMarkers:function(e){console.info(e)}}}).factory("MapIcons",function(){function e(e){var o=this;google.maps.Marker.apply(o,arguments),e.map_icon_label&&(o.MarkerLabel=new MarkerLabel({map:o.map,marker:o,text:e.map_icon_label}),o.MarkerLabel.bindTo("position",o,"position"))}var o="M0-48c-9.8 0-17.7 7.8-17.7 17.4 0 15.5 17.7 30.6 17.7 30.6s17.7-15.4 17.7-30.6c0-9.6-7.9-17.4-17.7-17.4z";return{pin:function(){return o},Marker:function(o){return e(o)},init:function(){var o=function(e,o){function t(){}t.prototype=o.prototype,e.superClass_=o.prototype,e.prototype=new t,e.prototype.constructor=e};o(e,google.maps.Marker),e.prototype.setMap=function(){google.maps.Marker.prototype.setMap.apply(this,arguments),this.MarkerLabel&&this.MarkerLabel.setMap.apply(this.MarkerLabel,arguments)};var t=function(e){var o=this;this.setValues(e),this.div=document.createElement("div"),this.div.className="map-icon-label",google.maps.event.addDomListener(this.div,"click",function(e){e.stopPropagation&&e.stopPropagation(),google.maps.event.trigger(o.marker,"click")})};t.prototype=new google.maps.OverlayView,t.prototype.onAdd=function(){var e=(this.getPanes().overlayImage.appendChild(this.div),this);this.listeners=[google.maps.event.addListener(this,"position_changed",function(){e.draw()}),google.maps.event.addListener(this,"text_changed",function(){e.draw()}),google.maps.event.addListener(this,"zindex_changed",function(){e.draw()})]},t.prototype.onRemove=function(){this.div.parentNode.removeChild(this.div);for(var e=0,o=this.listeners.length;o>e;++e)google.maps.event.removeListener(this.listeners[e])},t.prototype.draw=function(){var e=this.getProjection(),o=e.fromLatLngToDivPixel(this.get("position")),t=this.div;this.div.innerHTML=this.get("text").toString(),t.style.zIndex=this.get("zIndex"),t.style.position="absolute",t.style.display="block",t.style.left=o.x-t.offsetWidth/2+"px",t.style.top=o.y-t.offsetHeight+"px"}}}}).factory("ConnectivityMonitor",function(e,o){return{isOnline:function(){return ionic.Platform.isWebView()?o.isOnline():navigator.onLine},isOffline:function(){return ionic.Platform.isWebView()?!o.isOnline():!navigator.onLine}}}).factory("GoogleMaps",function(e,o,t,n,a,i,r){function l(){var o={timeout:1e4,enableHighAccuracy:!0};e.getCurrentPosition(o).then(function(e){var o=new google.maps.LatLng(e.coords.latitude,e.coords.longitude),t={center:o,zoom:16,mapTypeId:google.maps.MapTypeId.ROADMAP};L=new google.maps.Map(document.getElementById("map"),t),google.maps.event.addListenerOnce(L,"idle",function(){g(),google.maps.event.addListener(L,"dragend",function(){console.log("drag = reload map"),g()}),google.maps.event.addListener(L,"zoom_changed",function(){console.log("zoom = reload map"),g()}),s()})},function(e){console.warn("Could not get location"),g()})}function s(){o.hide()}function c(){console.warn("map disabled"),o.show({template:"You must be connected to the Internet to view this map."})}function p(){o.show({template:"Loading Google Maps"}),window.mapInit=function(){l()};var e=document.createElement("script");e.type="text/javascript",e.id="googleMaps",b?e.src="http://maps.google.com/maps/api/js?key="+b+"&callback=mapInit":(console.warn("no API key found"),e.src="http://maps.google.com/maps/api/js?callback=mapInit"),document.body.appendChild(e)}function d(){console.log("checking if loaded"),"undefined"==typeof google||"undefined"==typeof google.maps?p():s()}function g(){var e=L.getCenter(),o=L.getBounds(),t=L.getZoom(),n={lat:e.lat(),lng:e.lng()},r={northeast:{lat:o.getNorthEast().lat(),lng:o.getNorthEast().lng()},southwest:{lat:o.getSouthWest().lat(),lng:o.getSouthWest().lng()}},l=f(n,r),s={centre:n,bounds:r,zoom:t,boundingRadius:l};a.getMarkers(s).then(function(e){for(var o=e.data.markers,t=0;t<o.length;t++){var n=o[t];if(!u(n.lat,n.lng)){i.init();var a=i.pin(),r=new google.maps.LatLng(n.lat,n.lng),l=new google.maps.Marker({map:L,animation:google.maps.Animation.DROP,label:n.count,icon:{path:a,fillcolor:"#FFC900",fillOpacity:.5,strokeColor:"#FFC900",strokeWeight:2},map_icon_label:'<span class="map-icon map-icon-point-of-interest"></span>',position:r}),s={lat:n.lat,lng:n.lng,marker:l};w.push(s),k.push(n);var c="<h4><small>Road: </small>"+n.road+"</h4><p>Point: "+n.point+"</p><p>Free space: "+n.count+"</p><p>Road infomation: "+n.dict+"</p>";v(l,c,n)}}})}function u(e,o){for(var t=!1,n=w,a=0;a<n.length;a++)n[a].lat===e&&n[a].lng===o&&(t=!0);return t}function f(e,o){return m(e,o.northeast,"miles")}function m(e,o,t){var n={miles:3958.8,km:6371},a=n[t||"miles"],i=e.lat,r=e.lng,l=o.lat,s=o.lng,c=h(l-i),p=h(s-r),d=Math.sin(c/2)*Math.sin(c/2)+Math.cos(h(i))*Math.cos(h(l))*Math.sin(p/2)*Math.sin(p/2),g=2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d)),u=a*g;return u}function h(e){return e*Math.PI/180}function v(e,o,t){var n=new google.maps.InfoWindow({content:o});google.maps.event.addListener(e,"click",function(){n.open(L,e)})}function y(){ionic.Platform.isWebView?(t.$on("$cordovaNetwork:online",function(e,o){d(),console.info("device online")}),t.$on("$cordovaNetwork:offline",function(e,o){c(),console.warn("device offline")})):(window.addEventListener("online",function(e){d(),console.log("browser online")},!1),window.addEventListener("offline",function(e){c(),console.log("browser offline")},!1))}function M(){var e={roads:formA.rd.value,points:formA.pt.value,latitude:formA.lat.value,longitude:formA.lng.value,capactiy:formA.cap.value,counter:formA.ctr.value,dictionary:formA.dic.value};a.postMarkers(e)}var w=[],k=[],b=!1,L=null;return{init:function(e){"undefined"!=typeof e&&(b=e),"undefined"==typeof google||"undefined"==typeof google.maps?r.isOnline()?p():(c(),console.warn("google is undefined"),console.warn("Google Maps SDK needs to be loaded")):r.isOnline()?(w=[],l(),s()):c(),y()},listMarkers:function(){t.loadCache=k},addMarker:function(){M()}}}).controller("MapCtrl",function(e,o,t,n){n.init("AIzaSyDt1Hn4Nag4LRzZY-b6Jn0leKDc2ZMwXns"),t.fromTemplateUrl("templates/data.html",{scope:e}).then(function(o){e.modalC=o}),t.fromTemplateUrl("templates/list.html",{scope:e}).then(function(o){e.modalRUD=o,n.listMarkers()}),e.listMarkers=function(){n.listMarkers()},e.addMarker=function(){n.addMarker()}});