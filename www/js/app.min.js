angular.module("Spasey",["ionic","ngCordova"]).run(function(e){e.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&StatusBar.styleDefault()})}).config(function(e,t){e.state("map",{url:"/",templateUrl:"templates/map.html",controller:"MapCtrl"}),t.otherwise("/")}).factory("Markers",function(e){return{getMarkers:function(t){return e.get("http://localhost:8000/markers.php",{params:t}).then(function(e){var t=e;return t})},createMarker:function(e){console.info("<<NEW MARKER ADDED>>"),console.log(e)},updateMarker:function(e){console.info("<<MARKER UPDATED>>"),console.log(e)},deleteMarker:function(e){console.info("<<MARKER DELETED>>"),console.log(e)}}}).factory("ConnectivityMonitor",function(e,t){return{isOnline:function(){return ionic.Platform.isWebView()?t.isOnline():navigator.onLine},isOffline:function(){return ionic.Platform.isWebView()?!t.isOnline():!navigator.onLine}}}).factory("GoogleMaps",function(e,t,n,o,i,a){function r(){var t={timeout:1e4,enableHighAccuracy:!0};e.getCurrentPosition(t).then(function(e){P={lat:e.coords.latitude,lng:e.coords.longitude};var t=new google.maps.LatLng(W.lat,W.lng),n={center:t,zoom:16,zoomControl:!1,fullscreenControl:!0,disableDefaultUI:!0,mapTypeId:google.maps.MapTypeId.ROADMAP};K=new google.maps.Map(document.getElementById("map"),n),google.maps.event.addListenerOnce(K,"idle",function(){d(),google.maps.event.addListener(K,"dragend",function(){d()}),google.maps.event.addListener(K,"zoom_changed",function(){d()}),c()}),b()},function(e){$(".ion-ios-paper-outline").disable(),console.warn("Could not get location"),d()})}function c(){t.hide()}function l(){console.warn("map disabled"),t.show({template:"You must be connected to the Internet to view this map."})}function s(){t.show({template:"Loading Google Maps"}),window.mapInit=function(){r()};var e=document.createElement("script");e.type="text/javascript",e.id="googleMaps",z?e.src="http://maps.google.com/maps/api/js?key="+z+"&callback=mapInit":(console.warn("no API key found"),e.src="http://maps.google.com/maps/api/js?callback=mapInit"),document.body.appendChild(e)}function u(){console.log("checking if loaded"),"undefined"==typeof google||"undefined"==typeof google.maps?s():c()}function d(){var e=K.getCenter(),t=K.getBounds(),n=K.getZoom(),o={lat:e.lat(),lng:e.lng()},a={northeast:{lat:t.getNorthEast().lat(),lng:t.getNorthEast().lng()},southwest:{lat:t.getSouthWest().lat(),lng:t.getSouthWest().lng()}},r=g(o,a),c={centre:o,bounds:a,zoom:n,boundingRadius:r};i.getMarkers(c).then(function(e){function t(e){google.maps.Marker.apply(this,arguments),e.map_icon_label&&(this.MarkerLabel=new i({map:this.map,marker:this,text:e.map_icon_label}),this.MarkerLabel.bindTo("position",this,"position"))}var n="M0-48c-9.8 0-17.7 7.8-17.7 17.4 0 15.5 17.7 30.6 17.7 30.6s17.7-15.4 17.7-30.6c0-9.6-7.9-17.4-17.7-17.4z",o=function(e,t){function n(){}n.prototype=t.prototype,e.superClass_=t.prototype,e.prototype=new n,e.prototype.constructor=e};o(t,google.maps.Marker),t.prototype.setMap=function(){google.maps.Marker.prototype.setMap.apply(this,arguments),this.MarkerLabel&&this.MarkerLabel.setMap.apply(this.MarkerLabel,arguments)};var i=function(e){var t=this;this.setValues(e),this.div=document.createElement("div"),this.div.className="map-icon-label",google.maps.event.addDomListener(this.div,"click",function(e){e.stopPropagation&&e.stopPropagation(),google.maps.event.trigger(t.marker,"click")})};i.prototype=new google.maps.OverlayView,i.prototype.onAdd=function(){var e=(this.getPanes().overlayImage.appendChild(this.div),this);this.listeners=[google.maps.event.addListener(this,"position_changed",function(){e.draw()}),google.maps.event.addListener(this,"text_changed",function(){e.draw()}),google.maps.event.addListener(this,"zindex_changed",function(){e.draw()})]},i.prototype.onRemove=function(){this.div.parentNode.removeChild(this.div);for(var e=0,t=this.listeners.length;t>e;++e)google.maps.event.removeListener(this.listeners[e])},i.prototype.draw=function(){var e=this.getProjection(),t=e.fromLatLngToDivPixel(this.get("position")),n=this.div;this.div.innerHTML=this.get("text").toString(),n.style.zIndex=this.get("zIndex"),n.style.position="absolute",n.style.display="block",n.style.left=t.x-n.offsetWidth/2+"px",n.style.top=t.y-n.offsetHeight+"px"};for(var a=e.data.markers,r=0;r<a.length;r++){var c=a[r];if(!p(c.latitude,c.longitude)){var l=new google.maps.LatLng(c.latitude,c.longitude),s=new t({map:K,animation:google.maps.Animation.DROP,icon:{path:n,fillcolor:"#FFC900",fillOpacity:.5,strokeColor:"#FFC900",strokeWeight:2},map_icon_label:'<span class="map-icon-label-ticker">'+c.counter+"</span>",position:l}),u={lat:c.latitude,lng:c.longitude,marker:s};R.push(u),N.push(c),I(s,c)}}}).then(function(){return L()})}function p(e,t){for(var n=!1,o=R,i=0;i<o.length;i++)o[i].lat===e&&o[i].lng===t&&(n=!0);return n}function g(e,t){return f(e,t.northeast,"miles")}function f(e,t,n){var o={miles:3958.8,km:6371},i=o[n||"miles"],a=e.lat,r=e.lng,c=t.lat,l=t.lng,s=m(c-a),u=m(l-r),d=Math.sin(s/2)*Math.sin(s/2)+Math.cos(m(a))*Math.cos(m(c))*Math.sin(u/2)*Math.sin(u/2),p=2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d)),g=i*p;return g}function m(e){return e*Math.PI/180}function h(){Z=!1,G&&(j=!1,H.removeClass("active"),V.removeClass("active"),B.addClass("active"))}function y(){B.removeClass("active")}function v(){Z=!0,G&&(j=!0,B.removeClass("active"),V.removeClass("active"),H.addClass("active"))}function k(){angular.element(document.querySelector(".map-icon-label-ticker.active")).removeClass("active"),H.removeClass("active")}function M(){F&&(j=!0,B.removeClass("active"),H.removeClass("active"),V.addClass("active"))}function C(){angular.element(document.querySelector(".map-icon-label-ticker.active")).removeClass("active"),V.removeClass("active")}function w(){ionic.Platform.isWebView?(n.$on("$cordovaNetwork:online",function(e,t){u(),console.info("device online")}),n.$on("$cordovaNetwork:offline",function(e,t){l(),console.warn("device offline")})):(window.addEventListener("online",function(e){u(),console.log("browser online")},!1),window.addEventListener("offline",function(e){l(),console.log("browser offline")},!1))}function b(){G?(console.log("ADMIN"),google.maps.event.addListener(K,"click",function(e){_(e),h()})):F&&(_(),console.log("BASIC"))}function L(){n.listCache=N}function _(e){if(e){var t=e.latLng.lat().toString(),o=e.latLng.lng().toString();U=[{capacity:"",counter:"",dictionary:"",latitude:t,longitude:o,points:"",roads:""}]}else U=[{capacity:"",counter:"",dictionary:"",latitude:"",longitude:"",points:"",roads:""}];n.newCache=U}function A(e){q={capacity:e.capacity,counter:e.counter,dictionary:e.dictionary,latitude:e.latitude,longitude:e.longitude,points:e.points,roads:e.roads},n.tempCache=q}function D(e){e?(Z=!0,T=[{_capacity:e.capacity,capacity:e.capacity,_counter:e.counter,counter:e.counter,_dictionary:e.dictionary,dictionary:e.dictionary,latitude:e.latitude,longitude:e.longitude,_points:e.points,points:e.points,_roads:e.roads,roads:e.roads}]):T=[{capacity:"",counter:"",dictionary:"",latitude:"",longitude:"",points:"",roads:""}],n.editCache=T}function E(e){e.counter<9&&(T=[{_capacity:e.capacity,capacity:e.capacity,_counter:e.counter,counter:e.counter++,_dictionary:e.dictionary,dictionary:e.dictionary,latitude:e.latitude,longitude:e.longitude,_points:e.points,points:e.points,_roads:e.roads,roads:e.roads}])}function S(e){e.counter>0&&(T=[{_capacity:e.capacity,capacity:e.capacity,_counter:e.counter,counter:e.counter--,_dictionary:e.dictionary,dictionary:e.dictionary,latitude:e.latitude,longitude:e.longitude,_points:e.points,points:e.points,_roads:e.roads,roads:e.roads}])}function I(e,t){google.maps.event.addListener(e,"click",function(){D(t),angular.element(document.querySelector(".map-icon-label-ticker.active")).removeClass("active"),O=angular.element(this.MarkerLabel.div.children[0]),O.addClass("active"),G?v():M()})}function x(){K.panTo(P)}var O,P,R=[],N=[],T=[],U=[],q={},z=!1,K=null,W={lat:51.5060752,lng:-.0047033},B=angular.element(document.querySelector(".actibox-new")),H=angular.element(document.querySelector(".actibox-edit")),V=angular.element(document.querySelector(".actibox-counter")),j=!1,F=!0,G=!1,Z=!1;return{init:function(e){"undefined"!=typeof e&&(z=e),"undefined"==typeof google||"undefined"==typeof google.maps?a.isOnline()?s():(l(),console.warn("google is undefined"),console.warn("Google Maps SDK needs to be loaded")):a.isOnline()?(R=[],r(),c()):l(),w()},clickMap:function(){F&&j?(M(),j=!1):G&&j?(v(),j=!1):G&&!j&&(h(),j=!1)},clickNewClose:function(){y()},clickEditClose:function(){k()},clickCounterClose:function(){C()},clickCounterUp:function(e){E(e)},clickCounterDown:function(e){S(e)},setCenter:function(){x()},listMarkers:function(){L()},newMarker:function(e){G&&(e&&(A(e),i.createMarker(q)),_())},editMarker:function(e){G&&e&&D(e)},editOnce:function(){return Z},updateMarker:function(e){G&&e&&(A(e),i.updateMarker(q),D())},updateCounter:function(e){e&&(A(e),i.updateMarker(q))},deleteMarker:function(e){G&&e&&(A(e),i.deleteMarker(q))},setAdmin:function(e){e?(F=!1,G=!0):(F=!0,G=!1),b()}}}).directive("toggleClass",function(){return{restrict:"A",link:function(e,t,n){t.bind("click",function(){t.toggleClass(n.toggleClass)})}}}).controller("MapCtrl",function(e,t,n,o,i){i.init("AIzaSyDt1Hn4Nag4LRzZY-b6Jn0leKDc2ZMwXns"),n.fromTemplateUrl("templates/new.html",{scope:e}).then(function(t){e.modalC=t,i.newMarker()}),n.fromTemplateUrl("templates/list.html",{scope:e}).then(function(t){e.modalR=t}),n.fromTemplateUrl("templates/edit.html",{scope:e}).then(function(t){e.modalUD=t}),e.clickMap=function(){i.clickMap(),i.editOnce()&&(e.empty=!1)},e.clickNewHide=function(){i.clickNewClose()},e.clickEditHide=function(){i.clickEditClose()},e.clickCounterHide=function(){i.clickCounterClose()},e.setCenter=function(){i.setCenter()},e.listMarkers=function(){i.listMarkers()},e.addMarker=function(e){i.newMarker(e)},e.editMarker=function(t){e.empty=!1,i.editMarker(t),o.closeOptionButtons(),e.modalUD.show(),e.modalR.hide()},e.updateMarker=function(t){e.empty=!0,i.updateMarker(t)},e.updateCounter=function(t){e.empty=!0,i.updateCounter(t)},e.counterUp=function(e){i.clickCounterUp(e)},e.counterDown=function(e){i.clickCounterDown(e)},e.deleteMarker=function(e){i.deleteMarker(e)},e.setAdmin=function(e){1==e?i.setAdmin(e):i.setAdmin()};var a=!1;e.empty=!0,e.basic=!0,e.toggleAdmin=function(t){return a?(a=!1,e.basic=!0,angular.element(document.querySelector(".btn-list")).addClass("basic"),e.setAdmin()):(e.setAdmin(t),a=!0,angular.element(document.querySelector(".btn-list")).removeClass("basic"),void(e.basic=!1))}});