angular.module("Spasey",["ionic","ngCordova"]).run(function(e){e.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&StatusBar.styleDefault()})}).config(function(e,t){e.state("map",{url:"/",templateUrl:"templates/map.html",controller:"MapCtrl"}),t.otherwise("/")}).factory("Markers",function(e){return{getMarkers:function(t){return e.get("http://localhost:8000/markers.php",{params:t}).then(function(e){var t=e;return t})},createMarker:function(e){console.info(e)},updateMarker:function(e){console.info(e)},deleteMarker:function(e){console.info(e)}}}).factory("ConnectivityMonitor",function(e,t){return{isOnline:function(){return ionic.Platform.isWebView()?t.isOnline():navigator.onLine},isOffline:function(){return ionic.Platform.isWebView()?!t.isOnline():!navigator.onLine}}}).factory("GoogleMaps",function(e,t,n,o,a,i){function r(){var t={timeout:1e4,enableHighAccuracy:!0};e.getCurrentPosition(t).then(function(e){var t=new google.maps.LatLng(e.coords.latitude,e.coords.longitude);y={lat:e.coords.latitude,lng:e.coords.longitude};var n={center:t,zoom:16,zoomControl:!1,fullscreenControl:!0,disableDefaultUI:!0,mapTypeId:google.maps.MapTypeId.ROADMAP};C=new google.maps.Map(document.getElementById("map"),n),google.maps.event.addListenerOnce(C,"idle",function(){d(),google.maps.event.addListener(C,"click",function(){v()}),google.maps.event.addListener(C,"dragend",function(){d()}),google.maps.event.addListener(C,"zoom_changed",function(){d()}),s()})},function(e){$(".ion-ios-paper-outline").disable(),console.warn("Could not get location"),d()})}function s(){t.hide()}function l(){console.warn("map disabled"),t.show({template:"You must be connected to the Internet to view this map."})}function c(){t.show({template:"Loading Google Maps"}),window.mapInit=function(){r()};var e=document.createElement("script");e.type="text/javascript",e.id="googleMaps",L?e.src="http://maps.google.com/maps/api/js?key="+L+"&callback=mapInit":(console.warn("no API key found"),e.src="http://maps.google.com/maps/api/js?callback=mapInit"),document.body.appendChild(e)}function p(){console.log("checking if loaded"),"undefined"==typeof google||"undefined"==typeof google.maps?c():s()}function d(){var e=C.getCenter(),t=C.getBounds(),n=C.getZoom(),o={lat:e.lat(),lng:e.lng()},i={northeast:{lat:t.getNorthEast().lat(),lng:t.getNorthEast().lng()},southwest:{lat:t.getSouthWest().lat(),lng:t.getSouthWest().lng()}},r=u(o,i),s={centre:o,bounds:i,zoom:n,boundingRadius:r};a.getMarkers(s).then(function(e){function t(e){google.maps.Marker.apply(this,arguments),e.map_icon_label&&(this.MarkerLabel=new s({map:this.map,marker:this,text:e.map_icon_label}),this.MarkerLabel.bindTo("position",this,"position"))}for(var n=e.data.markers,o=0;o<n.length;o++){var a=n[o];if(!g(a.lat,a.lng)){var i="M0-48c-9.8 0-17.7 7.8-17.7 17.4 0 15.5 17.7 30.6 17.7 30.6s17.7-15.4 17.7-30.6c0-9.6-7.9-17.4-17.7-17.4z",r=function(e,t){function n(){}n.prototype=t.prototype,e.superClass_=t.prototype,e.prototype=new n,e.prototype.constructor=e};r(t,google.maps.Marker),t.prototype.setMap=function(){google.maps.Marker.prototype.setMap.apply(this,arguments),this.MarkerLabel&&this.MarkerLabel.setMap.apply(this.MarkerLabel,arguments)};var s=function(e){var t=this;this.setValues(e),this.div=document.createElement("div"),this.div.className="map-icon-label",google.maps.event.addDomListener(this.div,"click",function(e){e.stopPropagation&&e.stopPropagation(),google.maps.event.trigger(t.marker,"click")})};s.prototype=new google.maps.OverlayView,s.prototype.onAdd=function(){var e=(this.getPanes().overlayImage.appendChild(this.div),this);this.listeners=[google.maps.event.addListener(this,"position_changed",function(){e.draw()}),google.maps.event.addListener(this,"text_changed",function(){e.draw()}),google.maps.event.addListener(this,"zindex_changed",function(){e.draw()})]},s.prototype.onRemove=function(){this.div.parentNode.removeChild(this.div);for(var e=0,t=this.listeners.length;t>e;++e)google.maps.event.removeListener(this.listeners[e])},s.prototype.draw=function(){var e=this.getProjection(),t=e.fromLatLngToDivPixel(this.get("position")),n=this.div;this.div.innerHTML=this.get("text").toString(),n.style.zIndex=this.get("zIndex"),n.style.position="absolute",n.style.display="block",n.style.left=t.x-n.offsetWidth/2+"px",n.style.top=t.y-n.offsetHeight+"px"};var l=new google.maps.LatLng(a.lat,a.lng),c=new t({map:C,animation:google.maps.Animation.DROP,icon:{path:i,fillcolor:"#FFC900",fillOpacity:.5,strokeColor:"#FFC900",strokeWeight:2},map_icon_label:'<span class="map-icon map-icon-parking"></span><span class="map-icon-label-ticker">'+a.count+"</span>",position:l}),p={lat:a.lat,lng:a.lng,marker:c};w.push(p),b.push(a);var d="<h4><small>Road: </small>"+a.road+"</h4><p>Point: "+a.point+"</p><p>Free space: "+a.count+"</p><p>Road infomation: "+a.dict+"</p>";h(c,d,a)}}})}function g(e,t){for(var n=!1,o=w,a=0;a<o.length;a++)o[a].lat===e&&o[a].lng===t&&(n=!0);return n}function u(e,t){return f(e,t.northeast,"miles")}function f(e,t,n){var o={miles:3958.8,km:6371},a=o[n||"miles"],i=e.lat,r=e.lng,s=t.lat,l=t.lng,c=m(s-i),p=m(l-r),d=Math.sin(c/2)*Math.sin(c/2)+Math.cos(m(i))*Math.cos(m(s))*Math.sin(p/2)*Math.sin(p/2),g=2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d)),u=a*g;return u}function m(e){return e*Math.PI/180}function h(e,t,n){var o=new google.maps.InfoWindow({content:t});google.maps.event.addListener(e,"click",function(){o.open(C,e)})}function v(){console.log("INFOPOP")}function M(){ionic.Platform.isWebView?(n.$on("$cordovaNetwork:online",function(e,t){p(),console.info("device online")}),n.$on("$cordovaNetwork:offline",function(e,t){l(),console.warn("device offline")})):(window.addEventListener("online",function(e){p(),console.log("browser online")},!1),window.addEventListener("offline",function(e){l(),console.log("browser offline")},!1))}function k(){C.setCenter(y)}var y,w=[],b=[],L=!1,C=null;return{init:function(e){"undefined"!=typeof e&&(L=e),"undefined"==typeof google||"undefined"==typeof google.maps?i.isOnline()?c():(l(),console.warn("google is undefined"),console.warn("Google Maps SDK needs to be loaded")):i.isOnline()?(w=[],r(),s()):l(),M()},setCenter:function(){k()},listMarkers:function(){n.loadCache=b},addMarker:function(){a.createMarker()},editMarker:function(){a.updateMarker()},delMarker:function(){a.deleteMarker()}}}).controller("MapCtrl",function(e,t,n,o){o.init("AIzaSyDt1Hn4Nag4LRzZY-b6Jn0leKDc2ZMwXns"),n.fromTemplateUrl("templates/data.html",{scope:e}).then(function(t){e.modalC=t,e.mkr={lng:"",lat:"",cap:"",ctr:"",dic:"",rd:"",pt:""}}),n.fromTemplateUrl("templates/list.html",{scope:e}).then(function(t){e.modalRUD=t,o.listMarkers()}),e.setCenter=function(){o.setCenter()},e.listMarkers=function(){o.listMarkers()},e.addMarker=function(){o.addMarker()},e.editMarker=function(){o.editMarker()},e.deleteMarker=function(){o.delMarker()}});