angular.module("Spasey",["ionic","ngCordova"]).run(function(t){t.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&StatusBar.styleDefault()})}).config(function(t,e){t.state("map",{url:"/",templateUrl:"templates/map.html",controller:"MapCtrl"}),e.otherwise("/")}).factory("Markers",function(t){return{getMarkers:function(e){return t.get("http://localhost:8000/markers.php",{params:e}).then(function(t){var e=t;return e})},createMarker:function(t){console.info("<<NEW MARKER ADDED>>"),console.log(t)},updateMarker:function(t){console.info("<<MARKER UPDATED>>"),console.log(t)},deleteMarker:function(t){console.info("<<MARKER DELETED>>"),console.log(t)}}}).factory("ConnectivityMonitor",function(t,e){return{isOnline:function(){return ionic.Platform.isWebView()?e.isOnline():navigator.onLine},isOffline:function(){return ionic.Platform.isWebView()?!e.isOnline():!navigator.onLine}}}).factory("GoogleMaps",function(t,e,n,o,i,a){function r(){var e={timeout:1e4,enableHighAccuracy:!0};t.getCurrentPosition(e).then(function(t){var e=new google.maps.LatLng(t.coords.latitude,t.coords.longitude);C={lat:t.coords.latitude,lng:t.coords.longitude};var n={center:e,zoom:16,zoomControl:!1,fullscreenControl:!0,disableDefaultUI:!0,mapTypeId:google.maps.MapTypeId.ROADMAP};A=new google.maps.Map(document.getElementById("map"),n),google.maps.event.addListenerOnce(A,"idle",function(){p(),y(),google.maps.event.addListener(A,"dragend",function(){p()}),google.maps.event.addListener(A,"zoom_changed",function(){p()}),s()})},function(t){$(".ion-ios-paper-outline").disable(),console.warn("Could not get location"),p()})}function s(){e.hide()}function l(){console.warn("map disabled"),e.show({template:"You must be connected to the Internet to view this map."})}function c(){e.show({template:"Loading Google Maps"}),window.mapInit=function(){r()};var t=document.createElement("script");t.type="text/javascript",t.id="googleMaps",R?t.src="http://maps.google.com/maps/api/js?key="+R+"&callback=mapInit":(console.warn("no API key found"),t.src="http://maps.google.com/maps/api/js?callback=mapInit"),document.body.appendChild(t)}function d(){console.log("checking if loaded"),"undefined"==typeof google||"undefined"==typeof google.maps?c():s()}function p(){var t=A.getCenter(),e=A.getBounds(),n=A.getZoom(),o={lat:t.lat(),lng:t.lng()},a={northeast:{lat:e.getNorthEast().lat(),lng:e.getNorthEast().lng()},southwest:{lat:e.getSouthWest().lat(),lng:e.getSouthWest().lng()}},r=g(o,a),s={centre:o,bounds:a,zoom:n,boundingRadius:r};i.getMarkers(s).then(function(t){function e(t){google.maps.Marker.apply(this,arguments),t.map_icon_label&&(this.MarkerLabel=new i({map:this.map,marker:this,text:t.map_icon_label}),this.MarkerLabel.bindTo("position",this,"position"))}var n="M0-48c-9.8 0-17.7 7.8-17.7 17.4 0 15.5 17.7 30.6 17.7 30.6s17.7-15.4 17.7-30.6c0-9.6-7.9-17.4-17.7-17.4z",o=function(t,e){function n(){}n.prototype=e.prototype,t.superClass_=e.prototype,t.prototype=new n,t.prototype.constructor=t};o(e,google.maps.Marker),e.prototype.setMap=function(){google.maps.Marker.prototype.setMap.apply(this,arguments),this.MarkerLabel&&this.MarkerLabel.setMap.apply(this.MarkerLabel,arguments)};var i=function(t){var e=this;this.setValues(t),this.div=document.createElement("div"),this.div.className="map-icon-label",google.maps.event.addDomListener(this.div,"click",function(t){t.stopPropagation&&t.stopPropagation(),google.maps.event.trigger(e.marker,"click")})};i.prototype=new google.maps.OverlayView,i.prototype.onAdd=function(){var t=(this.getPanes().overlayImage.appendChild(this.div),this);this.listeners=[google.maps.event.addListener(this,"position_changed",function(){t.draw()}),google.maps.event.addListener(this,"text_changed",function(){t.draw()}),google.maps.event.addListener(this,"zindex_changed",function(){t.draw()})]},i.prototype.onRemove=function(){this.div.parentNode.removeChild(this.div);for(var t=0,e=this.listeners.length;e>t;++t)google.maps.event.removeListener(this.listeners[t])},i.prototype.draw=function(){var t=this.getProjection(),e=t.fromLatLngToDivPixel(this.get("position")),n=this.div;this.div.innerHTML=this.get("text").toString(),n.style.zIndex=this.get("zIndex"),n.style.position="absolute",n.style.display="block",n.style.left=e.x-n.offsetWidth/2+"px",n.style.top=e.y-n.offsetHeight+"px"};for(var a=t.data.markers,r=0;r<a.length;r++){var s=a[r];if(!u(s.latitude,s.longitude)){var l=new google.maps.LatLng(s.latitude,s.longitude),c=new e({map:A,animation:google.maps.Animation.DROP,icon:{path:n,fillcolor:"#FFC900",fillOpacity:.5,strokeColor:"#FFC900",strokeWeight:2},map_icon_label:'<span class="map-icon map-icon-parking"></span><span class="map-icon-label-ticker">'+s.counter+"</span>",position:l}),d={lat:s.latitude,lng:s.longitude,marker:c};D.push(d),E.push(s);var p="<h4><small>Road: </small>"+s.roads+"</h4><p>Point: "+s.points+"</p><p>Free space: "+s.counter+"</p><p>Road infomation: "+s.dictionary+"</p><button class='button button-dark' ng-click='editMarker()'>Edit</button><button class='button button-energized'>Delete</button>";h(c,p,s)}}}).then(function(){return v()})}function u(t,e){for(var n=!1,o=D,i=0;i<o.length;i++)o[i].lat===t&&o[i].lng===e&&(n=!0);return n}function g(t,e){return f(t,e.northeast,"miles")}function f(t,e,n){var o={miles:3958.8,km:6371},i=o[n||"miles"],a=t.lat,r=t.lng,s=e.lat,l=e.lng,c=m(s-a),d=m(l-r),p=Math.sin(c/2)*Math.sin(c/2)+Math.cos(m(a))*Math.cos(m(s))*Math.sin(d/2)*Math.sin(d/2),u=2*Math.atan2(Math.sqrt(p),Math.sqrt(1-p)),g=i*u;return g}function m(t){return t*Math.PI/180}function h(t,e,n){var o=new google.maps.InfoWindow({content:" "});google.maps.event.addListener(t,"click",function(n){o.setContent(e),console.info(n),b(n),o.open(A,t)})}function y(){var t=new google.maps.InfoWindow;google.maps.event.addListener(A,"click",function(e){k(e),t.setContent(e.latLng.lat()+","+e.latLng.lng()),t.open(A,this)})}function M(){ionic.Platform.isWebView?(n.$on("$cordovaNetwork:online",function(t,e){d(),console.info("device online")}),n.$on("$cordovaNetwork:offline",function(t,e){l(),console.warn("device offline")})):(window.addEventListener("online",function(t){d(),console.log("browser online")},!1),window.addEventListener("offline",function(t){l(),console.log("browser offline")},!1))}function v(){n.listCache=E}function k(t){if(t){var e=t.latLng.lat().toString(),o=t.latLng.lng().toString();_=[{capacity:"",counter:"",dictionary:"",latitude:e,longitude:o,points:"",roads:""}]}else _=[{capacity:"",counter:"",dictionary:"",latitude:"",longitude:"",points:"",roads:""}];n.newCache=_}function w(t){P={capacity:t.capacity,counter:t.counter,dictionary:t.dictionary,latitude:t.latitude,longitude:t.longitude,points:t.points,roads:t.roads},n.tempCache=P}function b(t){I=t?[{_capacity:t.capacity,capacity:t.capacity,_counter:t.counter,counter:t.counter,_dictionary:t.dictionary,dictionary:t.dictionary,latitude:t.latitude,longitude:t.longitude,_points:t.points,points:t.points,_roads:t.roads,roads:t.roads}]:[{capacity:"",counter:"",dictionary:"",latitude:"",longitude:"",points:"",roads:""}],n.editCache=I}function L(){A.panTo(C)}var C,D=[],E=[],I=[],_=[],P={},R=!1,A=null;return{init:function(t){"undefined"!=typeof t&&(R=t),"undefined"==typeof google||"undefined"==typeof google.maps?a.isOnline()?c():(l(),console.warn("google is undefined"),console.warn("Google Maps SDK needs to be loaded")):a.isOnline()?(D=[],r(),s()):l(),M()},setCenter:function(){L()},listMarkers:function(){v()},newMarker:function(t){t&&(w(t),i.createMarker(P)),k()},editMarker:function(t){t&&b(t)},updateMarker:function(t){t&&(w(t),i.updateMarker(P),b())},delMarker:function(t){i.deleteMarker(t)}}}).controller("MapCtrl",function(t,e,n,o,i){i.init("AIzaSyDt1Hn4Nag4LRzZY-b6Jn0leKDc2ZMwXns"),n.fromTemplateUrl("templates/new.html",{scope:t}).then(function(e){t.modalC=e,i.newMarker()}),n.fromTemplateUrl("templates/list.html",{scope:t}).then(function(e){t.modalR=e}),n.fromTemplateUrl("templates/edit.html",{scope:t}).then(function(e){t.modalUD=e}),t.selectMarker=function(e){t.editCache.push(this.edit)},t.setCenter=function(){i.setCenter()},t.listMarkers=function(){i.listMarkers()},t.addMarker=function(t){i.newMarker(t)},t.editMarker=function(e){i.editMarker(e),o.closeOptionButtons(),t.modalUD.show(),t.modalR.hide()},t.updateMarker=function(t){i.updateMarker(t)},t.deleteMarker=function(){i.delMarker()}});